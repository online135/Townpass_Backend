<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 引用外部 CSS 檔案 -->
    <link rel="stylesheet" href="style.css">

    <title>設定提醒</title>
</head>

<body>
    <div class="container">

         <!-- 新增返回按鈕 -->
         <button class="back-button" id="backButton">返回</button>

        <h1>設定提醒</h1>

        <!-- 標題輸入框 -->
        <div class="form-group">
            <label for="subjectName">標題</label>
            <input type="text" id="subjectName" placeholder="輸入提醒標題">
        </div>

        <!-- 時間選擇 -->
        <div class="form-group">
            <label for="time">時間</label>
            <input type="time" id="time" value="${new Date().toTimeString().substr(0, 5)}">
        </div>

        <!-- 重複選單 -->
        <div class="form-group flex-row">
            <label for="repeatSwitch">重複</label>
            <label class="switch">
                <input type="checkbox" id="repeatSwitch">
                <span class="slider round"></span>
            </label>
        </div>

        <!-- 複選下拉選單（預設隱藏） -->
        <div id="repeatContainer" style="display: none;">
            <select id="repeat" multiple>
                <option value="每天">每天</option>
                <option value="週一">週一</option>
                <option value="週二">週二</option>
                <option value="週三">週三</option>
                <option value="週四">週四</option>
                <option value="週五">週五</option>
                <option value="週六">週六</option>                    
                <option value="週日">週日</option>
            </select>
        </div>

        <!-- 主類別選單 -->
        <div class="form-group">
            <label for="mainCategory">主類別</label>
            <select id="mainCategory">
                <option value="">請選擇</option>
            </select>
        </div>

        <!-- 子類別選單 -->
        <div class="form-group">
            <label for="subCategory">子類別</label>
            <select id="subCategory" disabled>
                <option value="">請選擇</option>
            </select>
        </div>

        <!-- 通知方式選單 -->
        <div class="form-group">
            <label for="noticeMethod">通知方式</label>
            <select id="noticeMethod">
                <option></option>
                <option value="Line">Line</option>
                <option value="Email">Email</option>
                <option value="WhatsApp" disabled>WhatsApp(已停用)</option>
                <option value="簡訊" disabled>簡訊(已停用)</option>
            </select>
            <button class="test-button" id="testNotification">測試</button>
        </div>

        <!-- 保存按鈕 -->
        <button class="save-button" id="saveReminder">保存</button>
    </div>
</body>
</html>

<script>

    //返回鍵設定
    document.getElementById('backButton').addEventListener('click', function() {
        
        const subjectName = document.getElementById('subjectName').value.trim();
        const time = document.getElementById('time').value;
        const mainCategory = document.getElementById('mainCategory').value;
        const subCategory = document.getElementById('subCategory').value;
        const noticeMethod = document.getElementById('noticeMethod').value;

        // 檢查是否有已輸入的資料
        if (subjectName || time || mainCategory || subCategory || noticeMethod) {
            const confirmation = confirm('尚未保存資料，是否要放棄修改並返回？');
            if (confirmation) {
                window.history.back(); // 返回上一頁
            }
        } else {
            window.history.back(); // 沒有輸入內容，直接返回上一頁
        }
    });



        // Fetch categories from the backend
        async function fetchCategories() {
            try {
                const response = await fetch('/api/rss/mainCategories'); // Update URL if needed
                if (!response.ok) {
                    throw new Error('Failed to fetch categories');
                }
                const categories = await response.json();
                populateMainCategoryDropdown(categories);
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }

    // Populate the dropdown with main categories
    function populateMainCategoryDropdown(categories) {
        const mainCategorySelect = document.getElementById('mainCategory');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.code;
            option.textContent = category.displayName;
            mainCategorySelect.appendChild(option);
        });

        // Add change event listener to fetch and populate subcategories
        mainCategorySelect.addEventListener('change', function () {
            const selectedCategory = mainCategorySelect.value;
            const subCategorySelect = document.getElementById('subCategory');

            if (selectedCategory) {
                fetchSubcategories(selectedCategory);
                subCategorySelect.disabled = false;
            } else {
                clearSubCategoryDropdown();
                subCategorySelect.disabled = true;
            }
        });
    }

    // Fetch subcategories for the selected main category
    async function fetchSubcategories(categoryCode) {
        try {
            const response = await fetch(`/api/rss/mainCategories/${categoryCode}/`);
            if (!response.ok) {
                throw new Error('Failed to fetch subcategories');
            }
            const mainCategory = await response.json();
            populateSubCategoryDropdown(mainCategory.subCategories);
        } catch (error) {
            console.error('Error fetching subcategories:', error);
        }
    }

    // Populate the subcategory dropdown
    function populateSubCategoryDropdown(subCategories) {
        const subCategorySelect = document.getElementById('subCategory');
        clearSubCategoryDropdown();
        subCategories.forEach(subCategory => {
            const option = document.createElement('option');
            option.value = subCategory.code;
            option.textContent = subCategory.displayName;
            subCategorySelect.appendChild(option);
        });
    }

    // Clear the subcategory dropdown
    function clearSubCategoryDropdown() {
        const subCategorySelect = document.getElementById('subCategory');
        subCategorySelect.innerHTML = '<option value="">請選擇</option>';
    }

    // Call the function to fetch and populate categories on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetchCategories();
        
        const notificationId = getQueryParam('id');
        if (notificationId) {
            axios.get(`/api/notifications/${notificationId}`)
                .then(response => {
                    let notification = response.data;
                    document.getElementById('subjectName').value = notification.subjectName || '';
                    document.getElementById('time').value = `${notification.hour.toString().padStart(2, '0')}:${notification.minute.toString().padStart(2, '0')}`;
                    document.getElementById('mainCategory').value = notification.mainCategory || '';
                    document.getElementById('subCategory').value = notification.subCategory || '';
                    document.getElementById('noticeMethod').value = notification.noticeMethod || '';
                })
                .catch(error => {
                    console.error('獲取提醒資訊時出錯:', error);
                });
        }
    });

    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    document.getElementById('testNotification').addEventListener('click', function() {
        const method = document.getElementById('noticeMethod').value;
        if (method === '') {
            alert('請選擇通知方式後再進行測試。');
        } else {
            alert('測試通知已發送到 ' + method);
        }
    });

    document.getElementById('saveReminder').addEventListener('click', function() {
        const subjectName = document.getElementById('subjectName').value.trim();
        const time = document.getElementById('time').value;
        const mainCategory = document.getElementById('mainCategory').value;
        const subCategory = document.getElementById('subCategory').value;
        const noticeMethod = document.getElementById('noticeMethod').value;

        if (!subjectName || !time || !mainCategory || !subCategory || !noticeMethod) {
            alert('請填寫所有欄位。');
            return;
        }

        const notificationId = getQueryParam('id');
        const updatedNotification = {
            id: notificationId,
            subjectName: subjectName,
            hour: parseInt(time.split(':')[0]),
            minute: parseInt(time.split(':')[1]),
            mainCategory: mainCategory,
            subCategory: subCategory,
            noticeMethod: noticeMethod
        };

        axios.put(`/api/notifications/${notificationId}`, updatedNotification)
            .then(response => {
                alert('提醒已更新！');
                window.location.href = 'index.html';
            })
            .catch(error => {
                console.error('更新提醒時出錯:', error);
                alert('更新提醒時出錯。請重試。');
            });
    });

    document.getElementById('repeatSwitch').addEventListener('change', function() {
        const repeatContainer = document.getElementById('repeatContainer');
        repeatContainer.style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('repeat').addEventListener('change', function() {
        const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
        if (selectedOptions.includes('每天')) {
            Array.from(this.options).forEach(option => option.selected = true);
        }
    });
   //更新
document.getElementById('saveReminder').addEventListener('click', function() {
    const title = document.getElementById('title').value.trim();
    const time = document.getElementById('time').value;
    const mainCategory = document.getElementById('mainCategory').value;
    const subCategory = document.getElementById('subCategory').value;
    const noticeMethod = document.getElementById('noticeMethod').value;

    if (!title || !time || !mainCategory || !subCategory || !noticeMethod) {
        alert('請填寫所有欄位。');
        return;
    }

    const notificationId = getQueryParam('id');
    const updatedNotification = {
        id: notificationId,
        subjectName: title,
        hour: parseInt(time.split(':')[0]),
        minute: parseInt(time.split(':')[1]),
        mainCategory: mainCategory,
        subCategory: subCategory,
        noticeMethod: noticeMethod
    };

    axios.put(`/api/notifications/${notificationId}`, updatedNotification)
        .then(response => {
            alert('提醒已更新！');
            window.location.href = 'index.html';
        })
        .catch(error => {
            console.error('更新提醒時出錯:', error);
            alert('更新提醒時出錯。請重試。');
        });
});
</script>